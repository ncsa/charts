name: Release Charts

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        chart:
          - elasticsearch2
          - fah
          - geoserver
          - mlflow
          - uptime-kuma
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.3

      - name: Install Helm Repo
        run: |
          # Note: Bitnami chart repository (not bitnami-legacy)
          # bitnami-legacy is for Docker images only (docker.io/bitnamilegacy)
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Get chart version
        id: chart-version
        run: |
          VERSION=$(grep "^version:" charts/${{ matrix.chart }}/Chart.yaml | awk '{print $2}')
          {
            echo "version=$VERSION"
            echo "tag=${{ matrix.chart }}-$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Check if tag exists
        id: check-tag
        run: |
          TAG="${{ steps.chart-version.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Tag $TAG already exists, skipping release"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Tag $TAG does not exist, will create release"
          fi

      - name: Package chart
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          mkdir -p .cr-release-packages
          helm package charts/${{ matrix.chart }} --destination .cr-release-packages

      - name: Create git tag
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          TAG="${{ steps.chart-version.outputs.tag }}"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub release
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          TAG="${{ steps.chart-version.outputs.tag }}"
          CHART_FILE=".cr-release-packages/${{ matrix.chart }}-${{ steps.chart-version.outputs.version }}.tgz"
          gh release create "$TAG" "$CHART_FILE" --title "$TAG" --notes "Helm chart release for ${{ matrix.chart }}" --repo ncsa/charts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Helm index
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          # Fetch gh-pages branch
          git fetch origin gh-pages --depth=1

          # Get current index from gh-pages
          git show origin/gh-pages:index.yaml > index.yaml 2>/dev/null || printf "apiVersion: v1\nentries: {}\n" > index.yaml

          # Update index with new chart package
          helm repo index . --url https://github.com/ncsa/charts/releases/download --merge index.yaml

          # Commit and push to gh-pages
          git checkout gh-pages
          cp index.yaml .
          git add index.yaml
          git commit -m "chore: update index for ${{ matrix.chart }}-${{ steps.chart-version.outputs.version }}" || true
          git push origin gh-pages
