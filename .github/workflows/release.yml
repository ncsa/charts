name: Release Charts

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        chart:
          - elasticsearch2
          - fah
          - geoserver
          - mlflow
          - uptime-kuma
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get chart version and check if tag exists
        id: check-tag
        run: |
          VERSION=$(grep "^version:" charts/${{ matrix.chart }}/Chart.yaml | awk '{print $2}')
          TAG="${{ matrix.chart }}-$VERSION"
          {
            echo "version=$VERSION"
            echo "tag=$TAG"
          } >> "$GITHUB_OUTPUT"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Tag $TAG already exists, skipping release"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Tag $TAG does not exist, will create release"
          fi

      - name: Configure Git
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        if: steps.check-tag.outputs.exists == 'false'
        uses: azure/setup-helm@v4
        with:
          version: v3.16.3

      - name: Install Helm Repo
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          # Note: Bitnami chart repository (not bitnami-legacy)
          # bitnami-legacy is for Docker images only (docker.io/bitnamilegacy)
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Package chart
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          mkdir -p .cr-release-packages
          helm package charts/${{ matrix.chart }} --destination .cr-release-packages

      - name: Extract changelog entry
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          # Extract the changelog entry for this version and save to file
          VERSION="${{ steps.check-tag.outputs.version }}"
          CHANGELOG_FILE="charts/${{ matrix.chart }}/CHANGELOG.md"
          RELEASE_NOTES_FILE="/tmp/release-notes.md"

          if [ -f "$CHANGELOG_FILE" ]; then
            # Extract from ## [version] to the next ## (or end of file)
            sed -n "/^## \[$VERSION\]/,/^## \[/p" "$CHANGELOG_FILE" | sed '$d' > "$RELEASE_NOTES_FILE"

            if [ ! -s "$RELEASE_NOTES_FILE" ]; then
              echo "Release $VERSION" > "$RELEASE_NOTES_FILE"
            fi
          else
            echo "Release $VERSION" > "$RELEASE_NOTES_FILE"
          fi

      - name: Create git tag
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          git tag "${{ steps.check-tag.outputs.tag }}"
          git push origin "${{ steps.check-tag.outputs.tag }}"

      - name: Create GitHub release
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          CHART_FILE=".cr-release-packages/${{ matrix.chart }}-${{ steps.check-tag.outputs.version }}.tgz"
          gh release create "${{ steps.check-tag.outputs.tag }}" "$CHART_FILE" --title "${{ steps.check-tag.outputs.tag }}" --notes-file /tmp/release-notes.md --repo ncsa/charts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Helm index
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          # Fetch gh-pages branch
          git fetch origin gh-pages --depth=1

          # Get current index from gh-pages into temp location
          git show origin/gh-pages:index.yaml > /tmp/index.yaml 2>/dev/null || printf "apiVersion: v1\nentries: {}\n" > /tmp/index.yaml

          # Create temp directory for helm repo index work
          mkdir -p /tmp/index-work
          cd /tmp/index-work

          # Copy all chart packages to temp dir
          cp -r "$GITHUB_WORKSPACE"/.cr-release-packages/* .

          # Copy the existing index
          cp /tmp/index.yaml .

          # Update index with new chart package
          helm repo index . --url https://github.com/ncsa/charts/releases/download --merge index.yaml

          # Copy updated index back to workspace
          cp index.yaml "$GITHUB_WORKSPACE/index.yaml"

          # Commit and push to gh-pages (from workspace where git context exists)
          cd "$GITHUB_WORKSPACE"
          # Remove index.yaml before switching branches to avoid conflict
          rm -f index.yaml
          git checkout gh-pages
          # Copy the updated index back
          cp /tmp/index-work/index.yaml .
          git add index.yaml
          git commit -m "chore: update index for ${{ steps.check-tag.outputs.tag }}" || true
          git push origin gh-pages
