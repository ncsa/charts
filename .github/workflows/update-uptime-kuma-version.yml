name: Update Uptime Kuma Version

on:
  schedule:
    # Run every Sunday at 2:30 AM UTC
    - cron: "30 2 * * 0"
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests pyyaml packaging

      - name: Check for new Uptime Kuma version
        id: check_version
        run: |
          python3 - << 'PYEOF'
          import requests
          import yaml
          import os
          import re
          from packaging import version as pkg_version

          with open('charts/uptime-kuma/Chart.yaml', 'r') as f:
              chart = yaml.safe_load(f)
              current_version = chart['appVersion']

          print(f"Current version: {current_version}")

          # Check Docker Hub for louislam/uptime-kuma tags
          response = requests.get('https://hub.docker.com/v2/repositories/louislam/uptime-kuma/tags?page_size=100')
          data = response.json()

          # Match versions like 2.0.2, 2.1.0, etc. (full semantic versions)
          version_pattern = re.compile(r'^\d+\.\d+\.\d+$')
          versions = [tag['name'] for tag in data['results'] if version_pattern.match(tag['name'])]
          versions.sort(key=lambda v: pkg_version.parse(v), reverse=True)

          latest_version = versions[0] if versions else current_version
          print(f"Latest version: {latest_version}")

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"current_version={current_version}\n")
              f.write(f"latest_version={latest_version}\n")
              f.write(f"update_needed={'true' if latest_version != current_version else 'false'}\n")

          print(f"Update needed: {latest_version != current_version}")
          PYEOF

      - name: Update chart files
        if: steps.check_version.outputs.update_needed == 'true'
        env:
          NEW_VERSION: ${{ steps.check_version.outputs.latest_version }}
        run: |
          python3 - << 'PYEOF'
          import yaml
          import re
          import os
          from datetime import datetime

          new_version = os.environ['NEW_VERSION']

          # Update Chart.yaml
          with open('charts/uptime-kuma/Chart.yaml', 'r') as f:
              chart = yaml.safe_load(f)

          # Update appVersion
          chart['appVersion'] = new_version

          # Bump chart version (patch - third number)
          chart_version_parts = chart['version'].split('.')
          chart_version_parts[-1] = str(int(chart_version_parts[-1]) + 1)
          new_chart_version = '.'.join(chart_version_parts)
          chart['version'] = new_chart_version

          with open('charts/uptime-kuma/Chart.yaml', 'w') as f:
              yaml.dump(chart, f, default_flow_style=False, sort_keys=False)

          print(f"Updated Chart.yaml: chart version {new_chart_version}, appVersion {new_version}")

          # Update CHANGELOG.md
          current_date = datetime.utcnow().strftime('%Y-%m-%d')
          changelog_entry = f"""## [{new_chart_version}] - {current_date}

### Updated
- Updated Uptime Kuma from {os.environ.get('OLD_VERSION', 'previous version')} to {new_version}

"""

          with open('charts/uptime-kuma/CHANGELOG.md', 'r') as f:
              changelog_content = f.read()

          # Insert new entry after the main heading
          changelog_content = re.sub(
              r'(# Changelog\n\n.*?\n\n)',
              rf'\1{changelog_entry}',
              changelog_content,
              count=1,
              flags=re.DOTALL
          )

          with open('charts/uptime-kuma/CHANGELOG.md', 'w') as f:
              f.write(changelog_content)

          print("Updated CHANGELOG.md with new version entry")

          # Update README.md version information
          with open('charts/uptime-kuma/README.md', 'r') as f:
              readme_content = f.read()

          # Update image tag reference in table if present
          readme_content = re.sub(
              r'(\| `image\.tag` \| Image tag \| `""`.*?\(uses appVersion from Chart\.yaml\))',
              rf'\1',
              readme_content
          )

          with open('charts/uptime-kuma/README.md', 'w') as f:
              f.write(readme_content)

          print("Updated README.md")

          # Update root README.md
          with open('README.md', 'r') as f:
              root_readme = f.read()

          # Update the table row for uptime-kuma chart
          # Match pattern: | [uptime-kuma](charts/uptime-kuma) | VERSION | APPVERSION | Description |
          uptime_kuma_pattern = r'(\| \[uptime-kuma\]\(charts/uptime-kuma\) \| )([0-9]+\.[0-9]+\.[0-9]+)( \| )([0-9]+\.[0-9]+\.[0-9]+)( \| )'
          root_readme = re.sub(
              uptime_kuma_pattern,
              rf'\g<1>{new_chart_version}\g<3>{new_version}\g<5>',
              root_readme
          )

          with open('README.md', 'w') as f:
              f.write(root_readme)

          print(f"Updated root README.md: uptime-kuma chart version {new_chart_version}, appVersion {new_version}")
          PYEOF
        env:
          OLD_VERSION: ${{ steps.check_version.outputs.current_version }}

      - name: Create Pull Request
        if: steps.check_version.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update Uptime Kuma to version ${{ steps.check_version.outputs.latest_version }}

            - Updated Docker image from ${{ steps.check_version.outputs.current_version }} to ${{ steps.check_version.outputs.latest_version }}
            - Updated Chart.yaml appVersion and bumped chart version (patch)
            - Updated CHANGELOG.md with version information
          branch: update-uptime-kuma-${{ steps.check_version.outputs.latest_version }}
          delete-branch: true
          title: "chore: Update Uptime Kuma to version ${{ steps.check_version.outputs.latest_version }}"
          body: |
            ## Automated Uptime Kuma Version Update

            This PR updates the Uptime Kuma chart to use the latest available Docker image.

            ### Changes
            - **Previous version**: `${{ steps.check_version.outputs.current_version }}`
            - **New version**: `${{ steps.check_version.outputs.latest_version }}`
            - **Docker image**: `louislam/uptime-kuma:${{ steps.check_version.outputs.latest_version }}`

            ### Files Updated
            - `charts/uptime-kuma/Chart.yaml` - Updated appVersion and bumped chart version (patch)
            - `charts/uptime-kuma/CHANGELOG.md` - Added version update entry
            - `charts/uptime-kuma/README.md` - Updated documentation
            - `README.md` - Updated chart table with new versions

            ### Notes
            - This PR was automatically created by the Update Uptime Kuma Version workflow
            - Please review the changes and test before merging
            - Check [Docker Hub](https://hub.docker.com/r/louislam/uptime-kuma/tags) for release details
            - Check [GitHub Releases](https://github.com/louislam/uptime-kuma/releases) for changelog

            ### Important Storage Reminder
            Remember that Uptime Kuma requires local/block storage (no NFS) due to SQLite file locking requirements.

            ---
            *Generated by GitHub Actions*
          labels: |
            automated
            dependencies
            uptime-kuma
          assignees: robkooper
          draft: false
